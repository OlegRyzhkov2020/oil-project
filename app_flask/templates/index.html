<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8">
  <title>Home Page</title>
  <script>
  function scroll_to(target_id) {
    var container = document.getElementById('target-container');
    var scrollTo = document.getElementById(" " + target_id);
    container.scrollTop = scrollTo.offsetTop;
  }
  </script>
  <script src ="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
  <script src="http://d3js.org/topojson.v0.min.js"></script>

</head>
<body>
  {% extends "menu.html" %}
  {% block content %}
  <div class="container-fluid padding first-container">
    <span class="anchor" id="Home"></span>
    <div class="col-md-12">
      <div class="d-flex justify-content-between align-items-center breaking-news bg-white">
        <div class="d-flex flex-row flex-grow-1 flex-fill justify-content-center bg-news py-2 text-white px-1 news"><span class="d-flex align-items-center">&nbsp;Latest News</span></div>
        <marquee class="news-scroll" behavior="scroll" direction="left" onmouseover="this.stop();" onmouseout="this.start();"> <a >WTI CRUDE 40.60</a> <span class="dot"></span><a > BRENT CRUDE 42.85</a> <span class="dot"></span><a > ARAB LIGHT 42.32</a> <span class="dot"></span>><a URALS 39.60</a></marquee>
      </div>
    </div>
    <div class="row">
      <div class="row">
        <div class="col-md-5 text-center" >
          <h5>Energy Consumption by Energy Sources</h5>

            <div id="donut_container">
            </div>

        </div>
      <div class="col-md-3">
        <div class="table-responsive" style="height:460px">
          <table class="table table-sm" style="margin-bottom: 0">
            <thead>
              <tr class="table-dark">
                <th style="width: 35%">Date</th>
                <th style="width: 65%">News Title</th>
              </tr>
              {% for news in data %}
              <tr style='cursor: pointer; cursor: hand;' onclick="scroll_to('{{news['ID']}}');" class= "small">
                <td style="width: 35%">{{news['Date']}}</td>
                <td style="width: 65%">{{news['News_Title']}}</td>
              </tr >
              {% endfor %}
            </thead>
          </table>
        </div>
      </div>
      <div class="col-md-4 anyClass" id="target-container">
        {% for news in data %}
        <span class="picture" id=" {{news['ID']}}"></span>
        <div class="card">
          <img class="card-img-top" src={{news['Image_URL']}}>
          <div class="card-body">
            <h5 class="card-title">{{news['Image_Name']}}</h5>
            <p class="card-text">{{news['News_Paragraph']}}
            </p>
          </div>
          <hr class="light">
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  <figure>
    <div class="fixed-wrap">
      <div id="fixed">
      </div>
    </div>
  </figure>

<script>
d3.csv("static/data/product_2019.csv", function(data) {
  var filteredData = data.filter(d=> {
    return d.production>2000
  });
  showData(filteredData);
});

function showData(filteredData) {
  let bodyHeight = 200;
  let bodyWidth = 400;

  let donut_container = d3.select("#donut_container");
  data = {}
  for (var i=0; i<filteredData.length; i++) {
    data[filteredData[i].country_code] = filteredData[i].production;
  }
  console.log(data);
  // set the dimensions and margins of the graph
  var width = 450
      height = 450
      margin = 40

  // The radius of the pieplot is half the width or half the height (smallest one). I subtract a bit of margin.
  var radius = Math.min(width, height) / 2 - margin

  // append the svg object to the div called 'my_dataviz'
  var svg = donut_container.append("svg")
      .attr("width", width)
      .attr("height", height)
      .append("g")
      .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

  // Create dummy data
  // var data = {a: 9, b: 20, c:30, d:8, e:12}

  // set the color scale
  var color = d3.scaleOrdinal()
    .domain(data)
    .range(d3.schemeCategory10);
    //.range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#8a89a6"])

  // Compute the position of each group on the pie:
  var pie = d3.pie()
    .value(function(d) {return d.value; })
  var data_ready = pie(d3.entries(data))

    // The arc generator
  var arc = d3.arc()
    .innerRadius(radius * 0.5)         // This is the size of the donut hole
    .outerRadius(radius * 0.8)

  // Another arc that won't be drawn. Just for labels positioning
  var outerArc = d3.arc()
    .innerRadius(radius * 0.8)
    .outerRadius(radius * 0.9)


  // Build the pie chart: Basically, each part of the pie is a path that we build using the arc function.
  svg
    .selectAll('whatever')
    .data(data_ready)
    .enter()
    .append('path')
    .attr('d', d3.arc()
      .innerRadius(100)         // This is the size of the donut hole
      .outerRadius(radius)
    )
    .attr('fill', function(d){ return(color(d.data.key)) })
    .attr("stroke", "black")
    .style("stroke-width", "2px")
    .style("opacity", 0.7);

console.log(svg);

    // Add the polylines between chart and labels:
  svg
    .selectAll('allPolylines')
    .data(data_ready)
    .enter()
    .append('polyline')
      .attr("stroke", "black")
      .style("fill", "none")
      .attr("stroke-width", 1)
      .attr('points', function(d) {
        var posA = arc.centroid(d) // line insertion in the slice
        var posB = outerArc.centroid(d) // line break: we use the other arc generator that has been built only for that
        var posC = outerArc.centroid(d); // Label position = almost the same as posB
        var midangle = d.startAngle + (d.endAngle - d.startAngle) / 2 // we need the angle to see if the X position will be at the extreme right or extreme left
        posC[0] = radius * 0.95 * (midangle < Math.PI ? 1 : -1); // multiply by 1 or -1 to put it on the right or on the left
        return [posA, posB, posC]
      })
      // Add the polylines between chart and labels:
  svg
    .selectAll('allLabels')
    .data(data_ready)
    .enter()
    .append('text')
      .text( function(d) { console.log(d.data.key) ; return d.data.key } )
      .attr('transform', function(d) {
          var pos = outerArc.centroid(d);
          var midangle = d.startAngle + (d.endAngle - d.startAngle) / 2
          pos[0] = radius * 0.99 * (midangle < Math.PI ? 1 : -1);
          return 'translate(' + pos + ')';
      })
      .style('text-anchor', function(d) {
          var midangle = d.startAngle + (d.endAngle - d.startAngle) / 2
          return (midangle < Math.PI ? 'start' : 'end')
      })
  }
</script>

{% endblock %}
</body>
</html>
